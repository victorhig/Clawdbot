<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />

    <title>今年進度條</title>
    <meta name="description" content="顯示今年、本月或本週的進度；也可設定倒數目標日期。" />

    <!-- Canonical / SEO -->
    <link rel="canonical" href="https://victorhig.github.io/Clawdbot/" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="今年進度條" />
    <meta property="og:title" content="今年進度條" />
    <meta property="og:description" content="顯示今年、本月或本週的進度；也可設定倒數目標日期。" />
    <meta property="og:url" content="https://victorhig.github.io/Clawdbot/" />
    <meta property="og:image" content="https://victorhig.github.io/Clawdbot/og.svg" />
    <meta property="og:image:alt" content="今年進度條 — 顯示年度進度的簡潔進度條" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="今年進度條" />
    <meta name="twitter:description" content="顯示今年、本月或本週的進度；也可設定倒數目標日期。" />
    <meta name="twitter:image" content="https://victorhig.github.io/Clawdbot/og.svg" />

    <!-- PWA-ish -->
    <meta name="theme-color" content="#F5F6FA" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#0B0F17" media="(prefers-color-scheme: dark)" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="icon" href="./icon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="./icon.svg" />

    <style>
      :root{
        --bg: #f6f7fb;
        --card: rgba(255,255,255,.72);
        --text: #101828;
        --muted: #475467;
        --border: rgba(16,24,40,.08);
        --shadow: 0 16px 50px rgba(16,24,40,.10);

        --track: rgba(16,24,40,.08);
        --fill1: #8fd3f4;
        --fill2: #c5b3ff;
        --fill3: #b7f7d8;

        --btn: rgba(16,24,40,.06);
        --btnHover: rgba(16,24,40,.09);
        --focus: rgba(84, 112, 255, .35);
      }

      @media (prefers-color-scheme: dark){
        :root{
          --bg: #070a10;
          --card: rgba(255,255,255,.06);
          --text: #e7ecf6;
          --muted: #a7b0c2;
          --border: rgba(231,236,246,.10);
          --shadow: 0 18px 60px rgba(0,0,0,.45);

          --track: rgba(231,236,246,.12);
          --fill1: #6ecbff;
          --fill2: #b7a3ff;
          --fill3: #7cf0c0;

          --btn: rgba(231,236,246,.08);
          --btnHover: rgba(231,236,246,.12);
          --focus: rgba(124, 240, 192, .28);
        }
      }

      *{ box-sizing: border-box; }
      html,body{ height:100%; }
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        background:
          radial-gradient(900px 520px at 20% 15%, rgba(143,211,244,.45), transparent 55%),
          radial-gradient(880px 520px at 85% 25%, rgba(197,179,255,.35), transparent 58%),
          radial-gradient(900px 560px at 55% 90%, rgba(183,247,216,.28), transparent 55%),
          var(--bg);
        color: var(--text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        display:flex;
        align-items:center;
        justify-content:center;
        padding: 28px 18px;
      }

      .wrap{ width:min(920px, 100%); }

      header{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap: 14px;
        margin-bottom: 14px;
      }

      .title{
        display:flex;
        flex-direction:column;
        gap: 6px;
      }

      h1{
        font-size: clamp(24px, 4vw, 34px);
        margin:0;
        letter-spacing: -0.02em;
      }

      .sub{
        margin:0;
        color: var(--muted);
        font-size: 14px;
      }

      .card{
        border: 1px solid var(--border);
        background: var(--card);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border-radius: 22px;
        box-shadow: var(--shadow);
        padding: clamp(18px, 3vw, 28px);
      }

      .grid{
        display:grid;
        grid-template-columns: 1fr;
        gap: 18px;
        align-items:stretch;
      }

      .big{
        display:flex;
        flex-direction:column;
        gap: 14px;
      }

      .statRow{
        display:flex;
        align-items:baseline;
        justify-content:space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .percent{
        font-variant-numeric: tabular-nums;
        font-size: clamp(34px, 6.5vw, 58px);
        letter-spacing: -0.03em;
        line-height: 1.05;
      }

      .label{
        color: var(--muted);
        font-size: 13px;
      }

      .progress{
        height: 14px;
        border-radius: 999px;
        background: var(--track);
        overflow:hidden;
        border: 1px solid var(--border);
      }

      .fill{
        height: 100%;
        width: 0%;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--fill1), var(--fill2), var(--fill3));
        box-shadow: 0 10px 25px rgba(143,211,244,.22);
        transition: width 1200ms cubic-bezier(.2,.9,.2,1);
        position:relative;
      }

      .fill::after{
        content:"";
        position:absolute;
        inset:0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
        transform: translateX(-60%);
        animation: shine 2.8s ease-in-out infinite;
        opacity:.65;
      }

      @keyframes shine{
        0%{ transform: translateX(-70%); opacity:0; }
        30%{ opacity:.55; }
        60%{ opacity:.55; }
        100%{ transform: translateX(120%); opacity:0; }
      }

      @media (prefers-reduced-motion: reduce){
        .fill{ transition:none; }
        .fill::after{ display:none; }
      }

      .meta{
        display:grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        margin-top: 12px;
      }

      .pill{
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,.05);
      }

      .pill .v{
        font-size: 18px;
        font-variant-numeric: tabular-nums;
        letter-spacing: -0.01em;
      }

      .pill .k{ color: var(--muted); font-size: 12px; margin-top: 4px; }

      .side{
        display:flex;
        flex-direction:column;
        justify-content:space-between;
        gap: 14px;
      }

      .btns{
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content:flex-end;
      }

      .modes{
        display:flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .seg{
        appearance:none;
        border: 1px solid var(--border);
        background: rgba(255,255,255,.06);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 999px;
        font-size: 12px;
        cursor:pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
        display:inline-flex;
        gap: 8px;
        align-items:center;
        user-select:none;
      }

      .seg:hover{ background: var(--btnHover); transform: translateY(-1px); }
      .seg:active{ transform: translateY(0px); }
      .seg[aria-selected="true"]{
        background: rgba(143,211,244,.22);
        border-color: rgba(143,211,244,.35);
      }

      input[type="date"]{
        appearance:none;
        border: 1px solid var(--border);
        background: rgba(255,255,255,.06);
        color: var(--text);
        padding: 9px 10px;
        border-radius: 12px;
        font-size: 13px;
      }

      .row{
        display:flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items:center;
      }

      button{
        appearance:none;
        border: 1px solid var(--border);
        background: var(--btn);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 13px;
        cursor:pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
        display:inline-flex;
        gap: 8px;
        align-items:center;
      }

      body.widget header,
      body.widget footer,
      body.widget .side{ display:none; }
      body.widget .wrap{ width:min(760px, 100%); }
      body.widget{ padding: 18px 14px; }

      button:hover{ background: var(--btnHover); transform: translateY(-1px); }
      button:active{ transform: translateY(0px); }
      button:focus{ outline:none; box-shadow: 0 0 0 4px var(--focus); }

      .toast{
        min-height: 20px;
        color: var(--muted);
        font-size: 12px;
      }

      footer{
        margin-top: 14px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 12px;
        color: var(--muted);
        font-size: 12px;
      }

      a{ color: inherit; }
      .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div class="title">
          <h1>今年進度條</h1>
          <p class="sub">年度進度</p>
          <div class="modes" role="tablist" aria-label="模式">
            <button class="seg" type="button" data-view="year" aria-selected="true">年</button>
            <button class="seg" type="button" data-view="month" aria-selected="false">月</button>
            <button class="seg" type="button" data-view="week" aria-selected="false">週</button>
            <button class="seg" type="button" data-view="to" aria-selected="false">倒數</button>
          </div>
        </div>
        <div class="btns" aria-label="操作">
          <button id="shareBtn" type="button" title="分享">
            <span aria-hidden="true">↗</span><span>分享</span>
          </button>
          <button id="copyBtn" type="button" title="複製連結">
            <span aria-hidden="true">⧉</span><span>複製連結</span>
          </button>
        </div>
      </header>

      <section class="card">
        <div class="grid">
          <div class="big">
            <div class="statRow">
              <div>
                <div class="percent"><span id="pct">--.-</span>%</div>
                <div class="label" id="modeLabel">年度已完成</div>
              </div>
              <div style="text-align:right">
                <div class="percent" style="font-size: clamp(18px, 3.4vw, 28px); line-height:1.1">
                  <span id="rightPrefix">第</span> <span id="day">--</span> <span id="rightSuffix">天</span>
                </div>
                <div class="label"><span id="totalLabel">今年一共</span> <span id="days">--</span> 天</div>
              </div>
            </div>

            <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Year progress">
              <div class="fill" id="fill"></div>
            </div>

            <div class="meta">
              <div class="pill">
                <div class="v"><span id="date">----</span></div>
                <div class="k">今天日期</div>
              </div>
              <div class="pill">
                <div class="v"><span id="left">--</span></div>
                <div class="k" id="leftLabel">今年剩餘天數</div>
              </div>
              <div class="pill" id="toPill" style="display:none; grid-column: 1 / -1;">
                <div class="v" style="font-size:14px">倒數</div>
                <div class="k" style="font-size:13px; margin-top:10px; line-height:1.6">
                  <div class="row">
                    <input id="toDate" type="date" />
                    <button id="toEndYearBtn" type="button" title="設為年底">年底</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="toast" id="toast" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <footer>
        <div><span class="mono">victorhig/Clawdbot</span></div>
        <div><a href="https://github.com/victorhig/Clawdbot" target="_blank" rel="noreferrer">程式碼</a></div>
      </footer>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const toast = (msg) => {
        const el = $('toast');
        el.textContent = msg;
        clearTimeout(toast._t);
        toast._t = setTimeout(() => (el.textContent = ''), 2200);
      };

      const pad2 = (n) => String(n).padStart(2, '0');

      function isLeapYear(y){
        return (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0);
      }

      function dayOfYear(d){
        const start = new Date(d.getFullYear(), 0, 1);
        const diff = d - start;
        const oneDay = 24 * 60 * 60 * 1000;
        return Math.floor(diff / oneDay) + 1; // 1-based
      }

      const qp = new URLSearchParams(location.search);
      const getViewFromURL = () => (qp.get('view') || 'year').toLowerCase();
      const getWidgetFromURL = () => (qp.get('mode') || '').toLowerCase() === 'widget';

      function startOfDay(d){
        return new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }

      function daysBetween(a, b){
        const oneDay = 24 * 60 * 60 * 1000;
        return Math.round((startOfDay(b) - startOfDay(a)) / oneDay);
      }

      function startOfISOWeek(d){
        const x = startOfDay(d);
        const day = x.getDay(); // 0=Sun..6=Sat
        const diff = (day === 0 ? -6 : 1 - day); // to Monday
        x.setDate(x.getDate() + diff);
        return x;
      }

      function clamp(n, a, b){
        return Math.max(a, Math.min(b, n));
      }

      function fmtDate(d){
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      }

      function setSelectedView(view){
        document.querySelectorAll('.seg[data-view]').forEach((b) => {
          b.setAttribute('aria-selected', b.dataset.view === view ? 'true' : 'false');
        });
        $('toPill').style.display = (view === 'to') ? '' : 'none';
      }

      function update(){
        const now = new Date();
        const y = now.getFullYear();

        const yyyy = y;
        const mm = pad2(now.getMonth() + 1);
        const dd = pad2(now.getDate());
        $('date').textContent = `${yyyy}-${mm}-${dd}`;

        const view = window.__view || getViewFromURL();
        setSelectedView(view);

        let start, end, label, rightPrefix = '第', rightSuffix = '天', totalLabel = '今年一共', leftLabel = '今年剩餘天數';
        if (view === 'month'){
          start = new Date(y, now.getMonth(), 1);
          end = new Date(y, now.getMonth() + 1, 1);
          label = '本月已完成';
          rightSuffix = '天';
          totalLabel = '本月一共';
          leftLabel = '本月剩餘天數';
        } else if (view === 'week'){
          start = startOfISOWeek(now);
          end = new Date(start);
          end.setDate(end.getDate() + 7);
          label = '本週已完成';
          rightSuffix = '天';
          totalLabel = '本週一共';
          leftLabel = '本週剩餘天數';
        } else if (view === 'to'){
          const raw = qp.get('to') || localStorage.getItem('toDate') || '';
          const parsed = raw ? new Date(raw + 'T00:00:00') : null;
          const target = (parsed && !Number.isNaN(parsed.getTime())) ? parsed : new Date(y, 11, 31);
          const input = $('toDate');
          if (input) input.value = fmtDate(target);
          start = new Date(y, 0, 1);
          end = new Date(target);
          end.setDate(end.getDate() + 1); // inclusive
          label = '目標前已完成';
          rightPrefix = '距離';
          rightSuffix = '天';
          totalLabel = '目標總共';
          leftLabel = '距離目標';
        } else {
          start = new Date(y, 0, 1);
          end = new Date(y + 1, 0, 1);
          label = '年度已完成';
        }

        const totalDays = clamp(daysBetween(start, end), 1, 999999);
        const elapsedDays = clamp(daysBetween(start, now) + 1, 1, totalDays);
        const leftDays = clamp(totalDays - elapsedDays, 0, 999999);
        const pct = (elapsedDays / totalDays) * 100;

        $('modeLabel').textContent = label;
        $('rightPrefix').textContent = rightPrefix;
        $('rightSuffix').textContent = rightSuffix;
        $('totalLabel').textContent = totalLabel;
        $('leftLabel').textContent = leftLabel;

        $('pct').textContent = pct.toFixed(1);
        $('day').textContent = String(elapsedDays);
        $('days').textContent = String(totalDays);
        $('left').textContent = String(leftDays);

        // set progress bar
        const fill = $('fill');
        requestAnimationFrame(() => {
          fill.style.width = `${pct.toFixed(3)}%`;
          const pb = document.querySelector('[role="progressbar"]');
          pb.setAttribute('aria-valuenow', pct.toFixed(1));
          pb.setAttribute('aria-label', label);
        });

        // milestone hint (kept minimal; no extra side card)
        const ms = [25, 50, 75, 90];
        const next = ms.find((m) => pct < m);
        if (next){
          const needDays = Math.max(0, Math.ceil((next/100)*totalDays) - elapsedDays);
          // keep it subtle
          // toast(`下一個里程碑：${next}%（約還差 ${needDays} 天）`);
        }

        // update dynamic share text
        const viewName = (view === 'year') ? '今年' : (view === 'month') ? '本月' : (view === 'week') ? '本週' : '目標';
        window.__share = {
          title: '今年進度條',
          text: `${viewName}進度：第 ${elapsedDays}/${totalDays} 天（${pct.toFixed(1)}%）`,
          url: location.href
        };
      }

      async function copyLink(){
        try{
          await navigator.clipboard.writeText(location.href);
          toast('已複製連結');
        } catch {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = location.href;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
          toast('已複製連結');
        }
      }

      async function share(){
        const payload = window.__share || { title: document.title, url: location.href };
        if (navigator.share) {
          try{
            await navigator.share(payload);
          } catch {
            // user cancelled
          }
        } else {
          await copyLink();
          toast('此裝置不支援原生分享，已改為複製連結');
        }
      }

      function setView(view, opts = { pushURL: true }){
        window.__view = view;
        setSelectedView(view);
        if (opts.pushURL){
          const p = new URLSearchParams(location.search);
          p.set('view', view);
          const url = `${location.pathname}?${p.toString()}`;
          history.replaceState(null, '', url);
          // keep qp in sync
          qp.delete('view');
          p.forEach((v, k) => qp.set(k, v));
        }
        update();
      }

      document.querySelectorAll('.seg[data-view]').forEach((b) => {
        b.addEventListener('click', () => setView(b.dataset.view));
      });

      const toDate = $('toDate');
      if (toDate){
        toDate.addEventListener('change', () => {
          if (toDate.value) localStorage.setItem('toDate', toDate.value);
          const p = new URLSearchParams(location.search);
          p.set('to', toDate.value);
          p.set('view', 'to');
          history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
          qp.delete('to');
          qp.delete('view');
          p.forEach((v, k) => qp.set(k, v));
          setView('to', { pushURL: false });
        });
      }

      const endBtn = $('toEndYearBtn');
      if (endBtn){
        endBtn.addEventListener('click', () => {
          const now = new Date();
          const end = new Date(now.getFullYear(), 11, 31);
          const v = fmtDate(end);
          if (toDate) toDate.value = v;
          localStorage.setItem('toDate', v);
          const p = new URLSearchParams(location.search);
          p.set('to', v);
          p.set('view', 'to');
          history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
          qp.delete('to');
          qp.delete('view');
          p.forEach((vv, k) => qp.set(k, vv));
          setView('to', { pushURL: false });
          toast('已設定為年底');
        });
      }

      $('copyBtn').addEventListener('click', copyLink);
      $('shareBtn').addEventListener('click', share);

      if (getWidgetFromURL()) document.body.classList.add('widget');

      setView(getViewFromURL(), { pushURL: false });
      // refresh small clock
      setInterval(() => {
        update();
      }, 1000);
    </script>
  </body>
</html>
